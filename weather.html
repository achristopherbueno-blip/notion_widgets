<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Australian Weather Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #080d17;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --rain-blue: #4dabf7;
            --sun-gold: #ffcc00;
            --sunset-orange: #ff922b;
            --text-main: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.6);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; margin: 0; padding: 20px;
            overflow-x: hidden;
        }

        #city-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; background-size: cover; background-position: center;
            transition: background-image 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            filter: brightness(0.4) saturate(1.2);
        }

        /* Overlay to ensure text readability */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, transparent 0%, rgba(8, 13, 23, 0.4) 100%);
            z-index: -1;
        }

        .weather-widget {
            background: var(--glass);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 40px;
            width: 100%; max-width: 460px; padding: 35px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative; z-index: 10;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-bar { display: flex; gap: 12px; margin-bottom: 30px; }
        .search-bar input {
            flex: 1; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--glass-border);
            padding: 14px 22px; border-radius: 20px; color: white; outline: none;
            font-size: 0.95rem; transition: 0.3s;
        }
        .search-bar input:focus { background: rgba(0, 0, 0, 0.4); border-color: var(--rain-blue); }
        
        .search-bar button { 
            background: white; color: black; border: none; 
            width: 52px; height: 52px; border-radius: 20px; 
            cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .search-bar button:hover { transform: scale(1.08); background: #f0f0f0; }

        .header { text-align: center; }
        .city-name { margin: 0; font-size: 1.8rem; font-weight: 700; letter-spacing: -0.5px; }
        
        .sun-times { font-size: 0.85rem; font-weight: 500; color: var(--text-dim); }

        .temp-container { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 15px 0; }
        .main-weather-icon { font-size: 5rem; filter: drop-shadow(0 0 15px rgba(255,255,255,0.15)); cursor: help; }
        .temp-main { font-size: 6.5rem; font-weight: 800; letter-spacing: -5px; line-height: 1; }
        
        .feels-like { font-size: 1rem; color: var(--text-dim); margin-bottom: 25px; }

        .precip-container { 
            margin: 25px 0; background: rgba(255, 255, 255, 0.03); 
            padding: 20px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.05);
        }
        .precip-summary { font-size: 0.85rem; font-weight: 600; margin-bottom: 12px; color: var(--rain-blue); text-transform: uppercase; letter-spacing: 0.5px; }
        .precip-timeline { display: flex; align-items: flex-end; gap: 2px; height: 45px; }
        .precip-bar { flex: 1; background: rgba(255,255,255,0.08); border-radius: 4px; min-height: 3px; transition: 0.3s; }
        .precip-bar.active { background: var(--rain-blue); box-shadow: 0 0 8px rgba(77, 171, 247, 0.4); }

        .graph-wrapper { 
            background: rgba(0, 0, 0, 0.2); border-radius: 28px; 
            padding: 18px; margin: 30px 0; height: 260px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 30px; }
        .card { 
            background: rgba(255, 255, 255, 0.04); padding: 16px; border-radius: 22px; 
            text-align: center; border: 1px solid rgba(255,255,255,0.05);
            transition: 0.3s ease; position: relative; cursor: help;
        }
        .card:hover { background: rgba(255, 255, 255, 0.08); transform: translateY(-3px); }
        .card i { font-size: 1.5rem; margin-bottom: 8px; color: var(--rain-blue); display: block; }
        .card-val { font-size: 1rem; font-weight: 700; display: block; }
        .card-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); letter-spacing: 1px; margin-top: 4px; display: block; }

        /* REFINED TOOLTIP */
        .card::before, .tooltip-trigger::before {
            content: attr(data-tooltip);
            position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background: white; color: #080d17; padding: 10px 16px; border-radius: 14px;
            width: max-content; max-width: 200px; font-size: 0.75rem; font-weight: 600;
            opacity: 0; visibility: hidden; transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.5); pointer-events: none;
        }
        .card:hover::before, .tooltip-trigger:hover::before { opacity: 1; visibility: visible; bottom: 112%; }

        .forecast-row {
            display: grid; grid-template-columns: 85px 1fr 50px 50px;
            align-items: center; background: rgba(255, 255, 255, 0.03);
            padding: 14px 20px; border-radius: 20px; margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.02);
        }
    </style>
</head>
<body>

    <div id="city-bg"></div>

    <div class="weather-widget">
        <div class="search-bar">
            <input type="text" id="cityInput" placeholder="Search City..." />
            <button onclick="getWeather()"><i class="bi bi-search"></i></button>
        </div>

        <div class="header">
            <h2 id="cityName" class="city-name">Detecting...</h2>
            <div class="sun-times" style="display:flex; justify-content:center; gap:30px; margin:12px 0;">
                <span><i class="bi bi-sunrise" style="color:var(--sun-gold)"></i> <span id="sunrise">--:--</span></span>
                <span><i class="bi bi-sunset" style="color:var(--sunset-orange)"></i> <span id="sunset">--:--</span></span>
            </div>
            <div class="temp-container">
                <span class="tooltip-trigger" id="iconTrigger" data-tooltip="Weather Condition">
                    <i id="mainIcon" class="bi bi-cloud-sun main-weather-icon"></i>
                </span>
                <div class="temp-main"><span id="temp">--</span>°</div>
            </div>
            <div class="feels-like">Feels like <span id="feelsTemp">--</span>°</div>
        </div>

        <div class="precip-container">
            <div id="precipSummary" class="precip-summary">Analysing rainfall...</div>
            <div id="precipTimeline" class="precip-timeline"></div>
        </div>

        <div class="graph-wrapper">
            <canvas id="weatherChart"></canvas>
        </div>

        <div class="details" id="detailsGrid"></div>
        <div id="forecast" class="forecast-container"></div>
    </div>

    <script>
        let weatherChart;
        const iconMap = { 0: "bi-sun", 1: "bi-cloud-sun", 2: "bi-cloud-sun", 3: "bi-cloud", 45: "bi-cloud-fog", 61: "bi-cloud-rain", 95: "bi-cloud-lightning-rain" };
        const textMap = { 0: "Clear Sky", 1: "Mainly Clear", 2: "Partly Cloudy", 3: "Overcast", 45: "Foggy", 61: "Rainy", 95: "Stormy" };

        window.onload = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (p) => {
                    const lat = p.coords.latitude, lon = p.coords.longitude;
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                    const addr = await res.json();
                    const loc = addr.address.suburb || addr.address.city || addr.address.town || "Your Location";
                    fetchWeather(lat, lon, loc);
                }, () => fetchWeather(-27.47, 153.02, "Brisbane"));
            }
        };

        async function getWeather() {
            const city = document.getElementById('cityInput').value;
            if (!city) return;
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&format=json`);
            const data = await res.json();
            if (data.results) fetchWeather(data.results[0].latitude, data.results[0].longitude, data.results[0].name);
        }

        async function fetchWeather(lat, lon, label) {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m,relative_humidity_2m,uv_index,visibility&hourly=temperature_2m,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&minutely_15=precipitation&timezone=auto`);
            const data = await res.json();
            const aqRes = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=european_aqi`);
            const aqData = await aqRes.json();
            updateUI(data, aqData, label);
            updateBackground(data.current.weather_code, label);
            renderMinutePrecip(data.minutely_15.precipitation);
        }

        function updateUI(data, aqData, label) {
            document.getElementById('cityName').innerText = label;
            document.getElementById('temp').innerText = Math.round(data.current.temperature_2m);
            document.getElementById('feelsTemp').innerText = Math.round(data.current.apparent_temperature);
            
            const cond = textMap[data.current.weather_code] || "Variable";
            document.getElementById('mainIcon').className = `bi ${iconMap[data.current.weather_code] || 'bi-cloud'} main-weather-icon`;
            document.getElementById('iconTrigger').setAttribute('data-tooltip', cond);

            document.getElementById('sunrise').innerText = new Date(data.daily.sunrise[0]).toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', hour12: true });
            document.getElementById('sunset').innerText = new Date(data.daily.sunset[0]).toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', hour12: true });

            const uvVal = Math.round(data.current.uv_index);
            const aqiVal = aqData.current.european_aqi;

            document.getElementById('detailsGrid').innerHTML = `
                <div class="card" data-tooltip="Moderate winds. Secure loose outdoor furniture or items if gusty.">
                    <i class="bi bi-wind"></i><span class="card-val">${Math.round(data.current.wind_speed_10m)} km/h</span><span class="card-label">Wind Speed</span>
                </div>
                <div class="card" data-tooltip="Humidity level. Comfortable for most people is between 30% and 60%.">
                    <i class="bi bi-moisture"></i><span class="card-val">${data.current.relative_humidity_2m}%</span><span class="card-label">Humidity</span>
                </div>
                <div class="card" data-tooltip="UV ${uvVal}: ${uvVal >= 3 ? 'Sun protection required (Slip, Slop, Slap).' : 'No protection needed.'}">
                    <i class="bi bi-sun"></i><span class="card-val">Index ${uvVal}</span><span class="card-label">UV Level</span>
                </div>
                <div class="card" data-tooltip="Air Quality ${aqiVal}: ${aqiVal > 40 ? 'Air quality is fair. Sensitive groups should monitor.' : 'Excellent air quality. Enjoy outdoor activities!'}">
                    <i class="bi bi-lungs"></i><span class="card-val">${aqiVal} AQI</span><span class="card-label">Air Quality</span>
                </div>
            `;

            const fDiv = document.getElementById('forecast');
            fDiv.innerHTML = '';
            data.daily.time.forEach((day, i) => {
                fDiv.innerHTML += `
                    <div class="forecast-row">
                        <span style="font-weight:600; font-size:0.9rem;">${i===0?'Today':new Date(day).toLocaleDateString('en-AU',{weekday:'short'})}</span>
                        <span class="tooltip-trigger" data-tooltip="${textMap[data.daily.weather_code[i]]}">
                            <i class="bi ${iconMap[data.daily.weather_code[i]] || 'bi-cloud'}"></i>
                        </span>
                        <span style="font-weight:700; text-align:right;">${Math.round(data.daily.temperature_2m_max[i])}°</span>
                        <span style="color:var(--text-dim); text-align:right;">${Math.round(data.daily.temperature_2m_min[i])}°</span>
                    </div>`;
            });
            initChart(data.hourly.time.slice(0, 24), data.hourly.temperature_2m.slice(0, 24), data.hourly.precipitation_probability.slice(0, 24));
        }

        function initChart(times, temps, rain) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            if (weatherChart) weatherChart.destroy();
            
            const maxIdx = temps.indexOf(Math.max(...temps)), minIdx = temps.indexOf(Math.min(...temps));
            const currentHour = new Date().getHours();

            const nowLinePlugin = {
                id: 'nowLine',
                afterDraw: (chart) => {
                    const { ctx, scales: { x, y } } = chart;
                    const xPos = x.getPixelForValue(currentHour + ":00");
                    if (xPos === undefined) return;
                    ctx.save(); ctx.beginPath(); ctx.setLineDash([6, 4]);
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)'; ctx.lineWidth = 1.5;
                    ctx.moveTo(xPos, y.top); ctx.lineTo(xPos, y.bottom);
                    ctx.stroke(); ctx.restore();
                }
            };

            weatherChart = new Chart(ctx, {
                plugins: [nowLinePlugin],
                data: {
                    labels: times.map(t => new Date(t).getHours() + ":00"),
                    datasets: [
                        { 
                            label: 'Temp', type: 'line', data: temps, borderColor: '#fff', borderWidth: 2.5, tension: 0.4, 
                            pointRadius: temps.map((_, i) => (i === maxIdx || i === minIdx) ? 6 : 0),
                            pointBackgroundColor: temps.map((_, i) => i === maxIdx ? '#ff6b6b' : '#339af0'),
                            pointBorderColor: '#fff', pointBorderWidth: 2
                        },
                        { label: 'Rain', type: 'bar', data: rain, backgroundColor: 'rgba(77,171,247,0.2)', yAxisID: 'yRain', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { display: false },
                        tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, titleFont: { size: 14 }, bodyFont: { size: 13 },
                            callbacks: { label: c => c.dataset.label + ': ' + c.parsed.y + (c.datasetIndex === 0 ? '°' : '%') }
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.4)', font: {size: 10}, maxTicksLimit: 7 } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', font: {size: 10}, callback: v => v + '°' } },
                        yRain: { display: false, min: 0, max: 100 }
                    }
                }
            });
        }

        function renderMinutePrecip(data15) {
            const container = document.getElementById('precipTimeline'), summary = document.getElementById('precipSummary');
            container.innerHTML = '';
            const total = data15.slice(0, 4).reduce((a, b) => a + b, 0);
            summary.innerText = total === 0 ? "Clear skies for the next hour" : "Rain detected in the vicinity";
            for (let min = 0; min < 60; min++) {
                const bar = document.createElement('div'), val = data15[Math.floor(min / 15)] || 0;
                bar.className = 'precip-bar' + (val > 0.05 ? ' active' : '');
                bar.style.height = (val * 100) + 8 + '%';
                container.appendChild(bar);
            }
        }

        function updateBackground(code, cityName) {
            document.getElementById('city-bg').style.backgroundImage = `url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?auto=format&fit=crop&w=1600&q=80&sig=${cityName}')`;
        }
    </script>
</body>
</html>
